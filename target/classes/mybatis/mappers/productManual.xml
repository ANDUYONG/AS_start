<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
   "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
   
   <mapper namespace="mapper.Manual">
	<resultMap type="ProductVO" id="resultManual">
	
<!-- 			기본 제품VO			 -->
		<result property="productNo" column="productNo"/>
		<result property="productName" column="productName"/>
		<result property="productGroup" column="productGroup"/>
		<result property="useManual" column="useManual"/>
		<result property="asManual" column="asManual"/>
		<result property="productImage" column="productImage"/>
		
		
		
<!--				 추가	 				-->
<!-- 				승인 VO		 		-->
		<result property="approvalStatus" column="approvalStatus"/> <!-- appr.approvalstatus -->
		<result property="approvalNum" column="approvalNum"/> <!-- appr.approvalnum -->
		
<!-- 				member		 		-->
		<result property="manufacName" column="manufacName"/> <!-- m.name -->
		<result property="uno" column="uno"/> <!-- mb.uno -->
		<result property="cuId" column="cuId"/>
		
		<result property="totProduct" column="totProduct"/>
	</resultMap>
<!-- 사용자 권한 -->
		<select id="selectUserRight" parameterType="String" resultType="int">
			<![CDATA[
				select mb.uno uno from member mb where mb.cuid=#{cuId}
			]]>
		</select>
	
	
		
		<!-- 매뉴얼 리스트 / **제품리스트와 같다 -->
				<!-- 전체 리스트 숫자 가져오기 -->
		<select id="selectTotProduct" parameterType="int" resultType="Integer">
			<![CDATA[
			select count(approvalNum) totProduct from productApproval
			]]>
		</select>
		<select id="selectManualList" resultMap="resultManual" parameterType="java.util.Map">
			<![CDATA[
				select productName, 
					   productNo,
                       productGroup, 
                       manufacName, 
                       approvalStatus, 
                       approvalNum 
                from(
    				select  rowNum as recNum,
         			productName, productNo, productGroup, manufacName, approvalStatus, approvalNum
                    from (  select  p.name productName, p.prodgroup productGroup, p.productno productNo,
                               		m.name manufacName, appr.approvalstatus approvalStatus,
                               		appr.approvalNum approvalNum
                            from product p, productapproval appr, manufacturer m
                            where p.productno = appr.productno and m.cuid = p.cuid
                            order by approvalNum desc
                            )
            		)
			]]>
		     	where recNum between (#{section}-1)*100+ (#{pageNum}-1)*10+1 
		        	  and (#{section}-1)*100+(#{pageNum})*10
		        and approvalStatus=1                                                                     
		</select>
		
		<!-- 4-0. 제조사 이름 가져오기 -->
		<select id="manufacName" parameterType="String" resultType="String">
			<![CDATA[
				select m.name 
				from manufacturer m
				where m.cuId=#{cuId}
			]]>
		</select>
		
		<select id="manufacNameList" resultType="String">
			<![CDATA[
				select distinct(m.Name)
				from   manufacturer m, product p, productApproval appr
				where  m.cuid = p.cuid and p.productNo = appr.productNo
				       and appr.approvalstatus=1
			]]>
		</select>
		
<!-- 3. 제품검색  -->
		<select id="selectProductGroup" resultType="String" parameterType="java.util.Map">
			<![CDATA[
				select p.prodGroup productGroup
				from product p, manufacturer m
				where p.cuId = m.cuId and m.name=#{cuId}
			]]>
		</select>
		<select id="searchManual" resultType="ProductVO" parameterType="java.util.Map">
			    <include refid="search"/>
		</select>	
		
		<!-- 매뉴얼상세  -->
		<select id="selectManualDetail" resultMap="resultManual" parameterType="java.util.Map">
			<![CDATA[
			select 	   p.productimage 	productImage, 
					   p.name 			productName, 
                   	   m.name 			manufacName, 
                   	   p.prodgroup 		productGroup, 
                   	   p.usemanual 		useManual,
                   	   p.asmanual 		asManual 
            from 	   product p, productapproval appr, manufacturer m
            where 	   p.productno = appr.productno 
            		   and m.cuid = p.cuid
            		   and appr.approvalstatus=1
            		   and p.productNo = #{productNo}
            		   order by appr.approvalnum desc
			]]>

		</select>
		


<sql id="search"> 
<!-- 1. id="search" -->
				select     productName, 
	                       productGroup,
	                       productNo, 
	                       manufacName, 
	                       approvalStatus, 
	                       approvalNum 
	                from(
						   <include refid="selectSearch"/>		<!-- 2. id="selectSearch" -->
			        )
	        		where rowNum between (#{section}-1)*100 + (#{pageNum}-1)*10+1 and (#{section}-1)*100 + #{pageNum}*10
			</sql>
			
			<sql id="selectSearch">
				<![CDATA[
	    				select  rowNum as recNum,
	         			productName, productGroup, manufacName, approvalStatus, approvalNum, productNo
	                    from (  select  p.name productName, p.prodgroup productGroup, p.productNo productNo,
	                                    m.name manufacName, appr.approvalstatus approvalStatus,
	                                    appr.approvalNum approvalNum
	                            from product p, productapproval appr, manufacturer m
	                            where p.productno = appr.productno and m.cuid = p.cuid
	                            order by approvalNum DESC
	                            )
				]]>
				<include refid="searchCondition"/>  <!-- 3. id="searchCondition"  -->
			</sql>
			
			
			<sql id="searchCondition">
			where
			<if test = "productGroup != null">
			         productGroup=#{productGroup}
			        	<if test = "manufacName != null">
			        	  and manufacName=#{manufacName}
			        	</if>
			        	
			        	<if test = "manufacName == null">
				        	<if test = "productName != null">
					        		and productName like '%' || #{productName} || '%'
					        	</if>
	<!-- 아무것도 입력하지 않고 검색시 -->
					        	<if test = "productName == null">
					        		
					        		<if test="uno == 1 || uno == 2">  <!-- 공급자, 사용자 -->
							        	and approvalStatus=1                                                                     
							        </if>
				        	</if>
			        	</if>
			        </if>
	<!-- 제품분류를 선택하지 않을 시 -->
			        <if test = "productGroup == null">
			        	<if test = "manufacName != null">
			        			manufacName=#{manufacName}
			        		<if test = "productName != null">
			        			and productName like '%' || #{productName} || '%'
			        		</if>
			        		<if test="uno == 1 || uno == 2">  <!-- 공급자, 사용자 -->
						        and approvalStatus=1                                                                     
						   </if>
			        	</if>
			        	
			        	
			        	<if test = "manufacName == null">
			        	<!-- 제품이름만 검색시 -->
				        	<if test = "productName != null">
				        		productName like '%' || #{productName} || '%'
				        		<if test="uno == 1 || uno == 2">  <!-- 공급자, 사용자 -->
						        	and approvalStatus=1                                                                     
						        </if>
				        	</if>
				        	<!-- 아무것도 입력하지 않고 검색시 -->
				        	<if test = "productName == null">
				        		
				        		<if test="uno == 1 || uno == 2">  <!-- 공급자, 사용자 -->
						        	approvalStatus=1                                                                     
						        </if>
				        	</if>
			        	</if>
			        </if>
			</sql>
		
	</mapper>